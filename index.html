<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ–¨ï¸ Just-Printing-Server</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Light Gruvbox é…è‰²æ–¹æ¡ˆ -->
    <style>
        :root {
            /* Gruvbox Light èƒŒæ™¯å±‚æ¬¡ */
            --bg0: #fbf1c7;           /* æœ€æ·¡èƒŒæ™¯ - å¥¶æ²¹è‰² */
            --bg1: #f2e5bc;           /* æ¬¡æ·¡èƒŒæ™¯ */
            --bg2: #ebdbb2;           /* å¡ç‰‡/åŒºå—èƒŒæ™¯ */
            --bg3: #d5c4a1;           /* æ·±è‰²èƒŒæ™¯ */

            /* Gruvbox Light å‰æ™¯/æ–‡å­— */
            --fg0: #282828;           /* ä¸»è¦æ–‡å­— - æ·±ç° */
            --fg1: #3c3836;           /* æ¬¡è¦æ–‡å­— */
            --fg2: #504945;           /* å¼±åŒ–æ–‡å­— */
            --fg3: #665c54;           /* æœ€æ·¡æ–‡å­— */

            /* Gruvbox å¼ºè°ƒè‰² */
            --accent-red: #9d0006;    /* æŸ”å’Œçº¢ - ç”¨äºé”™è¯¯/é‡è¦æ“ä½œ */
            --accent-green: #79740e;  /* æ©„æ¦„ç»¿ - ç”¨äºæˆåŠŸçŠ¶æ€ */
            --accent-yellow: #b57614; /* æŸ”å’Œæ©™ - ç”¨äºè­¦å‘Š */
            --accent-blue: #076678;   /* æ·±é’è“ - ä¸»å¼ºè°ƒè‰² */
            --accent-purple: #8f3f71; /* ç´«çº¢ - æ¬¡å¼ºè°ƒè‰² */
            --accent-aqua: #427b58;   /* é’ç»¿ - ä¿¡æ¯æç¤º */
            --accent-orange: #af3a03; /* æ©™è‰² - é«˜äº® */

            /* è¯­ä¹‰åŒ–æ˜ å°„ */
            --bg-base: #fbf1c7;       /* é¡µé¢èƒŒæ™¯ */
            --bg-elevated: #f2e5bc;   /* å¡ç‰‡èƒŒæ™¯ */
            --bg-muted: #ebdbb2;      /* æ¬¡è¦åŒºå— */
            --text-primary: #282828;  /* ä¸»æ–‡å­— */
            --text-secondary: #504945;/* æ¬¡æ–‡å­— */
            --text-muted: #665c54;    /* å¼±æ–‡å­— */
            --accent: #076678;        /* ä¸»å¼ºè°ƒè‰² - æ·±é’è“ */
            --accent-hover: #055a68;  /* æ‚¬åœçŠ¶æ€ */
            --success: #79740e;       /* æˆåŠŸè‰² - æ©„æ¦„ç»¿ */
            --error: #9d0006;         /* é”™è¯¯è‰² - æŸ”å’Œçº¢ */
            --warning: #b57614;       /* è­¦å‘Šè‰² - æŸ”å’Œæ©™ */
            --border: #d5c4a1;        /* è¾¹æ¡†è‰² */
        }
        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- è®¤è¯é®ç½©ï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(40, 40, 40, 0.5);">
        <div class="p-8 max-w-md w-full" style="background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(40, 40, 40, 0.1);">
            <h2 class="text-2xl font-bold mb-6 text-center" style="color: var(--fg0);">è¾“å…¥è®¿é—®ç </h2>
            <input type="password" id="pin-input"
                   class="w-full p-3 mb-4 text-center text-xl"
                   style="background: var(--bg-base); border: 2px solid var(--border); border-radius: 10px; color: var(--fg0);"
                   placeholder="ğŸ”’ è¯·è¾“å…¥PINç " autofocus>
            <button id="login-btn"
                    class="w-full font-bold py-3 transition"
                    style="background: var(--accent); color: #fbf1c7; border-radius: 10px; box-shadow: 0 2px 6px rgba(7, 102, 120, 0.2);"
                    onmouseover="this.style.background='var(--accent-hover)'"
                    onmouseout="this.style.background='var(--accent)'">
                â¡ï¸ ç™»å½•
            </button>
            <div id="auth-error" class="mt-4 text-center hidden" style="color: var(--error);"></div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="main-app" class="hidden">
        <!-- æ ‡é¢˜æ  -->
        <header class="p-4 flex justify-between items-center" style="background: var(--bg-elevated); border-bottom: 1px solid var(--border);">
            <h1 class="text-xl font-bold" style="color: var(--fg0);">ğŸ–¨ï¸ Just-Printing-Server</h1>
            <button id="logout-btn" class="transition" style="color: var(--accent);" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">ğŸšª é€€å‡º</button>
        </header>

        <!-- å“åº”å¼å¸ƒå±€å®¹å™¨ -->
        <div class="container mx-auto p-4 md:flex md:space-x-6">
            <!-- å·¦ä¾§å†…å®¹åŒºåŸŸï¼ˆä¸Šä¼ ã€æ–‡ä»¶åˆ—è¡¨ã€è®¾ç½®ï¼‰ -->
            <div class="md:w-1/2">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="mb-6">
                    <div id="upload-area"
                         class="p-8 text-center cursor-pointer transition"
                         style="border: 2px dashed var(--border); border-radius: 16px; background: var(--bg-elevated);"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='#fff'"
                         onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-elevated)'">
                        <div class="text-4xl mb-2">ğŸ“¤</div>
                        <p class="text-lg" style="color: var(--fg0);">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½è‡³æ­¤</p>
                        <p class="text-sm mt-2" style="color: var(--text-muted);">æ”¯æŒ ğŸ“· å›¾ç‰‡ï¼ˆJPG/PNGï¼‰å’Œ ğŸ“„ PDFæ–‡ä»¶</p>
                        <input type="file" id="file-input" class="hidden" multiple>
                    </div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="mb-6">
                    <h2 class="text-lg font-bold mb-3" style="color: var(--fg0);">å·²ä¸Šä¼ æ–‡ä»¶</h2>
                    <div id="file-list" class="space-y-2">
                        <!-- æ–‡ä»¶é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>

                <!-- æ‰“å°æœºçŠ¶æ€ -->
                <div class="mb-6 p-4" style="background: var(--bg-elevated); border-radius: 12px; border: 1px solid var(--border);">
                    <h2 class="text-lg font-bold mb-2" style="color: var(--fg0);">æ‰“å°æœºçŠ¶æ€</h2>
                    <div id="printer-status" class="flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background: var(--warning);"></span>
                        <span style="color: var(--fg1);">ğŸŸ¡ æ£€æµ‹ä¸­</span>
                    </div>
                </div>

                <!-- æ‰“å°è®¾ç½® -->
                <div class="mb-6">
                    <h2 class="text-lg font-bold mb-3" style="color: var(--fg0);">æ‰“å°è®¾ç½®</h2>

                    <!-- ä»½æ•°è®¾ç½® -->
                    <div class="mb-4">
                        <label class="block mb-2" style="color: var(--fg1);">ğŸ“‹ ä»½æ•°</label>
                        <div class="flex items-center space-x-2">
                            <button id="copies-decrement" class="w-10 h-10 transition" style="background: var(--bg2); border-radius: 10px; color: var(--fg0);"
                                onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--bg2)'">-</button>
                            <input id="copies-input" type="text" value="1"
                                   class="text-center w-16 py-2" style="background: #fff; border: 1px solid var(--border); border-radius: 10px; color: var(--fg0);" readonly>
                            <button id="copies-increment" class="w-10 h-10 transition" style="background: var(--bg2); border-radius: 10px; color: var(--fg0);"
                                onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='var(--bg2)'">+</button>
                        </div>
                    </div>

                    <!-- å•åŒé¢è®¾ç½® -->
                    <div class="mb-4">
                        <label class="block mb-2" style="color: var(--fg1);">å•åŒé¢</label>
                        <div class="flex space-x-2">
                            <button id="sides-one" class="px-4 py-2 flex-1 transition" style="background: var(--accent); color: #fbf1c7; border-radius: 10px;">ğŸ“„ å•é¢</button>
                            <button id="sides-two" class="px-4 py-2 flex-1 transition" style="background: var(--bg2); color: var(--fg0); border-radius: 10px;">ğŸ“„ğŸ“„ åŒé¢</button>
                        </div>
                    </div>

                    <!-- è‰²å½©æ¨¡å¼ -->
                    <div class="mb-6">
                        <label class="block mb-2" style="color: var(--fg1);">è‰²å½©æ¨¡å¼</label>
                        <div class="flex space-x-2">
                            <button id="color-bw" class="px-4 py-2 flex-1 transition" style="background: var(--accent); color: #fbf1c7; border-radius: 10px;">âš« é»‘ç™½</button>
                            <button id="color-color" class="px-4 py-2 flex-1 transition" style="background: var(--bg2); color: var(--fg0); border-radius: 10px;">ğŸŒˆ å½©è‰²</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
            <div class="md:w-1/2">
                <div class="p-4 h-full" style="background: var(--bg-elevated); border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(40, 40, 40, 0.06);">
                    <h2 class="text-lg font-bold mb-3" style="color: var(--fg0);">PDFé¢„è§ˆ</h2>
                    <div id="preview-desktop" class="hidden">
                        <!-- æ¡Œé¢ç«¯PDFåµŒå…¥ -->
                        <embed id="pdf-embed" type="application/pdf" width="100%" height="600px">
                    </div>
                    <div id="preview-mobile" class="hidden">
                        <!-- ç§»åŠ¨ç«¯é¢„è§ˆæŒ‰é’® -->
                        <div class="text-center p-8">
                            <div class="text-4xl mb-4">ğŸ“„</div>
                            <p id="preview-info" class="mb-4" style="color: var(--fg1);">PDFå·²ç”Ÿæˆï¼ˆå…± 0 é¡µï¼‰</p>
                            <button id="preview-fullscreen" class="px-6 py-3 font-bold transition" style="background: var(--accent); color: #fbf1c7; border-radius: 10px;">
                                ç‚¹å‡»å…¨å±é¢„è§ˆ
                            </button>
                        </div>
                    </div>
                    <div id="preview-empty" class="text-center p-8" style="color: var(--text-muted);">
                        ğŸ“„ ä¸Šä¼ æ–‡ä»¶åé¢„è§ˆå°†åœ¨æ­¤æ˜¾ç¤º
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ ï¼ˆç§»åŠ¨ç«¯å›ºå®šï¼‰ -->
        <div id="mobile-action-bar" class="fixed bottom-0 left-0 right-0 p-4 flex justify-between md:hidden" style="background: var(--bg-elevated); border-top: 1px solid var(--border);">
            <button id="cancel-btn" class="px-6 py-3 transition" style="background: var(--bg2); border-radius: 10px; color: var(--fg0);">âŒ å–æ¶ˆ</button>
            <button id="print-btn" class="px-6 py-3 font-bold transition" style="background: var(--accent); color: #fbf1c7; border-radius: 10px;">ğŸ–¨ï¸ æ‰“å°</button>
        </div>

        <!-- æ¡Œé¢ç«¯æ“ä½œæ  -->
        <div class="mt-6 p-4 hidden md:block">
            <div class="flex justify-center space-x-4">
                <button id="cancel-btn-desktop" class="px-8 py-3 transition" style="background: var(--bg2); border-radius: 10px; color: var(--fg0);">âŒ å–æ¶ˆ</button>
                <button id="print-btn-desktop" class="px-8 py-3 font-bold transition" style="background: var(--accent); color: #fbf1c7; border-radius: 10px;">ğŸ–¨ï¸ æ‰“å°</button>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 z-40 hidden items-center justify-center" style="background: rgba(40, 40, 40, 0.4);">
        <div class="p-6" style="background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(40, 40, 40, 0.1);">
            <div class="animate-spin rounded-full h-12 w-12 mx-auto mb-4" style="border: 3px solid var(--border); border-top-color: var(--accent);"></div>
            <p id="loading-text" style="color: var(--fg0);">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <!-- JavaScriptå°†åœ¨è¿™é‡Œå†…è” -->
    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            authToken: localStorage.getItem('auth_token'),
            uploadedFiles: [],
            printSettings: {
                copies: 1,
                sides: 'one-sided',
                color_mode: 'monochrome'
            },
            printerStatus: 'unknown',
            printerStatusInterval: null,
            isMobile: window.innerWidth < 768
        };

        // ==================== å·¥å…·å‡½æ•° ====================

        // Toasté€šçŸ¥ç³»ç»Ÿ
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const borderColors = {
                success: 'var(--success)',
                error: 'var(--error)',
                info: 'var(--accent)'
            };
            toast.className = 'p-4 shadow-lg flex justify-between items-center';
            toast.style.cssText = `background: #fff; border-left: 4px solid ${borderColors[type]}; border-radius: 8px; color: var(--fg0);`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="ml-4" style="color: var(--text-muted);">âœ•</button>
            `;
            container.appendChild(toast);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);

            // æ‰‹åŠ¨å…³é—­
            toast.querySelector('button').addEventListener('click', () => {
                toast.remove();
            });
        }

        // åŠ è½½é®ç½©æ§åˆ¶
        function showLoading(text = 'å¤„ç†ä¸­...') {
            const overlay = document.getElementById('loading-overlay');
            const textEl = document.getElementById('loading-text');
            textEl.textContent = text;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(endpoint, options = {}) {
            const { method = 'GET', body = null, headers = {}, withAuth = true, timeout = 60000 } = options;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const requestHeaders = { ...headers };
            if (withAuth && state.authToken) {
                requestHeaders['Authorization'] = `Bearer ${state.authToken}`;
            }

            if (body && !(body instanceof FormData) && !(body instanceof Blob)) {
                requestHeaders['Content-Type'] = 'application/json';
            }

            try {
                const response = await fetch(endpoint, {
                    method,
                    headers: requestHeaders,
                    body: body instanceof FormData ? body : (body ? JSON.stringify(body) : null),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                // å¤„ç†HTTPé”™è¯¯çŠ¶æ€
                if (!response.ok) {
                    let errorMsg = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        // å¿½ç•¥JSONè§£æé”™è¯¯
                    }
                    throw new Error(errorMsg);
                }

                // å°è¯•è§£æJSONï¼Œå¯¹äºéJSONå“åº”è¿”å›åŸå§‹å“åº”
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return await response.blob();
                }
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶');
                }
                throw error;
            }
        }

        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è®¾å¤‡æ£€æµ‹å’Œå“åº”å¼å¸ƒå±€åˆ‡æ¢
        function checkDeviceWidth() {
            const isMobileNow = window.innerWidth < 768;
            if (isMobileNow !== state.isMobile) {
                state.isMobile = isMobileNow;
                updatePreviewVisibility();
            }
        }

        // ==================== è®¤è¯æ¨¡å— ====================

        function initAuth() {
            const pinInput = document.getElementById('pin-input');
            const loginBtn = document.getElementById('login-btn');
            const authOverlay = document.getElementById('auth-overlay');
            const mainApp = document.getElementById('main-app');
            const authError = document.getElementById('auth-error');

            // è®¾ç½®è¾“å…¥æ¡†å±æ€§
            pinInput.setAttribute('inputmode', 'numeric');

            // æ£€æŸ¥ç°æœ‰token
            if (state.authToken) {
                // éªŒè¯tokenæœ‰æ•ˆæ€§ï¼ˆé€šè¿‡ç®€å•çš„çŠ¶æ€æŸ¥è¯¢ï¼‰
                verifyTokenAndShowMain();
            } else {
                authOverlay.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }

            // å›è½¦ç™»å½•
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performLogin();
                }
            });

            // ç‚¹å‡»ç™»å½•
            loginBtn.addEventListener('click', performLogin);

            async function performLogin() {
                const token = pinInput.value.trim();
                if (!token) {
                    showAuthError('è¯·è¾“å…¥è®¿é—®ç ');
                    return;
                }

                showLoading('ç™»å½•ä¸­...');
                try {
                    const response = await apiRequest('/auth', {
                        method: 'POST',
                        body: { token },
                        withAuth: false
                    });

                    // ç™»å½•æˆåŠŸ
                    state.authToken = token;
                    localStorage.setItem('auth_token', token);
                    hideLoading();
                    authOverlay.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    showToast('ç™»å½•æˆåŠŸ', 'success');

                    // å¼€å§‹è½®è¯¢æ‰“å°æœºçŠ¶æ€
                    startPrinterStatusPolling();
                    // åˆå§‹åŒ–æ‰“å°è®¾ç½®
                    initPrintSettings();

                } catch (error) {
                    hideLoading();
                    showAuthError('è®¿é—®ç æ— æ•ˆ');
                    console.error('ç™»å½•å¤±è´¥:', error);
                }
            }

            function showAuthError(message) {
                authError.textContent = message;
                authError.classList.remove('hidden');
            }

            async function verifyTokenAndShowMain() {
                try {
                    // å°è¯•è·å–æ‰“å°æœºçŠ¶æ€æ¥éªŒè¯token
                    await apiRequest('/printer/status');
                    // tokenæœ‰æ•ˆ
                    authOverlay.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    startPrinterStatusPolling();
                    initPrintSettings();
                } catch (error) {
                    // tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºè®¤è¯ç•Œé¢
                    localStorage.removeItem('auth_token');
                    state.authToken = null;
                    authOverlay.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                }
            }
        }

        // ==================== æ–‡ä»¶ä¸Šä¼ æ¨¡å— ====================

        function initFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const fileList = document.getElementById('file-list');

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // æ‹–æ‹½æ”¯æŒ
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--accent)';
                uploadArea.style.background = '#fff';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--border)';
                uploadArea.style.background = 'var(--bg-elevated)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border)';
                uploadArea.style.background = 'var(--bg-elevated)';
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFiles(files);
                // æ¸…ç©ºinputä»¥ä¾¿é€‰æ‹©ç›¸åŒæ–‡ä»¶
                e.target.value = '';
            });

            async function handleFiles(files) {
                // è¿‡æ»¤æ”¯æŒçš„æ–‡ä»¶ç±»å‹
                const supportedTypes = ['image/jpeg', 'image/png', 'application/pdf', 'image/jpg'];
                const validFiles = files.filter(file =>
                    supportedTypes.includes(file.type.toLowerCase()) ||
                    file.name.toLowerCase().endsWith('.jpg') ||
                    file.name.toLowerCase().endsWith('.jpeg') ||
                    file.name.toLowerCase().endsWith('.png') ||
                    file.name.toLowerCase().endsWith('.pdf')
                );

                if (validFiles.length === 0) {
                    showToast('ä»…æ”¯æŒJPGã€PNGã€PDFæ–‡ä»¶', 'error');
                    return;
                }

                // é¡ºåºä¸Šä¼ æ¯ä¸ªæ–‡ä»¶
                for (const file of validFiles) {
                    await uploadFile(file);
                }
            }

            async function uploadFile(file) {
                // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨ï¼ˆä¸Šä¼ ä¸­çŠ¶æ€ï¼‰
                const fileId = Date.now() + Math.random();
                const fileItem = {
                    id: fileId,
                    name: file.name,
                    size: file.size,
                    status: 'uploading',
                    progress: 0
                };
                state.uploadedFiles.push(fileItem);
                updateFileList();

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('file', file);

                // ä½¿ç”¨XHRä»¥æ”¯æŒè¿›åº¦æ˜¾ç¤º
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const progress = Math.round((e.loaded / e.total) * 100);
                            fileItem.progress = progress;
                            updateFileItem(fileId);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                fileItem.status = 'success';
                                fileItem.pages = response.pages;
                                fileItem.size = response.size;
                                updateFileItem(fileId);
                                showToast(`${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');

                                // åˆ·æ–°é¢„è§ˆ
                                updatePreview();
                                resolve(response);
                            } catch (error) {
                                fileItem.status = 'error';
                                updateFileItem(fileId);
                                showToast(`${file.name} ä¸Šä¼ å¤±è´¥: å“åº”è§£æé”™è¯¯`, 'error');
                                reject(error);
                            }
                        } else {
                            fileItem.status = 'error';
                            updateFileItem(fileId);
                            let errorMsg = `HTTP ${xhr.status}`;
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMsg = errorData.error || errorMsg;
                            } catch (e) {}
                            showToast(`${file.name} ä¸Šä¼ å¤±è´¥: ${errorMsg}`, 'error');
                            reject(new Error(errorMsg));
                        }
                    });

                    xhr.addEventListener('error', () => {
                        fileItem.status = 'error';
                        updateFileItem(fileId);
                        showToast(`${file.name} ä¸Šä¼ å¤±è´¥: ç½‘ç»œé”™è¯¯`, 'error');
                        reject(new Error('Network error'));
                    });

                    xhr.addEventListener('abort', () => {
                        fileItem.status = 'error';
                        updateFileItem(fileId);
                        showToast(`${file.name} ä¸Šä¼ å·²å–æ¶ˆ`, 'error');
                        reject(new Error('Upload aborted'));
                    });

                    xhr.open('POST', '/upload');
                    xhr.setRequestHeader('Authorization', `Bearer ${state.authToken}`);
                    xhr.send(formData);
                });
            }

            function updateFileItem(fileId) {
                const items = document.querySelectorAll('#file-list .file-item');
                items.forEach(item => {
                    if (item.dataset.fileId === fileId.toString()) {
                        const fileItem = state.uploadedFiles.find(f => f.id === fileId);
                        if (fileItem) {
                            item.innerHTML = createFileItemHTML(fileItem);
                        }
                    }
                });
            }
        }

        // ==================== æ–‡ä»¶åˆ—è¡¨æ¸²æŸ“ ====================

        function updateFileList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            state.uploadedFiles.forEach(fileItem => {
                const div = document.createElement('div');
                div.className = 'file-item p-3 flex items-center justify-between';
                div.style.cssText = 'background: #fff; border: 1px solid var(--border); border-radius: 12px;';
                div.dataset.fileId = fileItem.id;
                div.innerHTML = createFileItemHTML(fileItem);
                fileList.appendChild(div);
            });

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶
            if (state.uploadedFiles.length === 0) {
                fileList.innerHTML = '<div class="text-center p-4" style="color: var(--text-muted);">ğŸ“­ æš‚æ— æ–‡ä»¶</div>';
            }
        }

        function createFileItemHTML(fileItem) {
            let statusHTML = '';
            if (fileItem.status === 'uploading') {
                statusHTML = `
                    <div class="flex items-center">
                        <div class="w-16 h-2 rounded-full mr-2 overflow-hidden" style="background: var(--border);">
                            <div class="h-full" style="width: ${fileItem.progress}%; background: var(--accent);"></div>
                        </div>
                        <span class="text-xs" style="color: var(--fg2);">â³ ${fileItem.progress}%</span>
                    </div>
                `;
            } else if (fileItem.status === 'success') {
                statusHTML = `
                    <div class="flex items-center">
                        <span class="mr-1">âœ…</span>
                        <span class="text-sm" style="color: var(--success);">å·²ä¸Šä¼ </span>
                    </div>
                `;
            } else {
                statusHTML = `
                    <div class="flex items-center">
                        <span class="mr-1">âŒ</span>
                        <span class="text-sm" style="color: var(--error);">ä¸Šä¼ å¤±è´¥</span>
                    </div>
                `;
            }

            return `
                <div class="flex-1">
                    <div class="font-medium truncate" style="color: var(--fg0);">${fileItem.name}</div>
                    <div class="text-sm" style="color: var(--text-muted);">${formatFileSize(fileItem.size)}</div>
                </div>
                ${statusHTML}
            `;
        }

        // ==================== é¢„è§ˆæ¨¡å— ====================

        function updatePreview() {
            if (state.uploadedFiles.length === 0 || state.uploadedFiles.every(f => f.status !== 'success')) {
                // æ²¡æœ‰æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                document.getElementById('preview-desktop').classList.add('hidden');
                document.getElementById('preview-mobile').classList.add('hidden');
                document.getElementById('preview-empty').classList.remove('hidden');
                return;
            }

            // æœ‰æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶
            document.getElementById('preview-empty').classList.add('hidden');
            updatePreviewVisibility();

            // æ›´æ–°PDFé¢„è§ˆæºï¼ˆæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰
            const timestamp = new Date().getTime();
            const pdfUrl = `/preview.pdf?token=${encodeURIComponent(state.authToken)}&t=${timestamp}`;

            // æ¡Œé¢ç«¯ï¼šæ›´æ–°embed
            const embed = document.getElementById('pdf-embed');
            embed.src = pdfUrl;

            // ç§»åŠ¨ç«¯ï¼šæ›´æ–°é¢„è§ˆæŒ‰é’®é“¾æ¥
            const previewBtn = document.getElementById('preview-fullscreen');
            previewBtn.onclick = () => {
                window.open(pdfUrl, '_blank');
            };

            // æ›´æ–°é¡µæ•°ä¿¡æ¯ï¼ˆéœ€è¦ä»åç«¯è·å–ï¼Œè¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
            const totalPages = state.uploadedFiles.reduce((sum, file) => sum + (file.pages || 1), 0);
            document.getElementById('preview-info').textContent = `PDFå·²ç”Ÿæˆï¼ˆå…± ${totalPages} é¡µï¼‰`;
        }

        function updatePreviewVisibility() {
            if (state.isMobile) {
                document.getElementById('preview-desktop').classList.add('hidden');
                document.getElementById('preview-mobile').classList.remove('hidden');
            } else {
                document.getElementById('preview-desktop').classList.remove('hidden');
                document.getElementById('preview-mobile').classList.add('hidden');
            }
        }

        // ==================== æ‰“å°è®¾ç½®UIäº¤äº’ ====================

        function initPrintSettings() {
            const copiesInput = document.getElementById('copies-input');
            const copiesDecrement = document.getElementById('copies-decrement');
            const copiesIncrement = document.getElementById('copies-increment');

            const sidesOne = document.getElementById('sides-one');
            const sidesTwo = document.getElementById('sides-two');

            const colorBw = document.getElementById('color-bw');
            const colorColor = document.getElementById('color-color');

            // åˆå§‹åŒ–æ˜¾ç¤º
            copiesInput.value = state.printSettings.copies;
            updateSidesButtons();
            updateColorButtons();

            // ä»½æ•°æ§åˆ¶
            copiesDecrement.addEventListener('click', () => {
                if (state.printSettings.copies > 1) {
                    state.printSettings.copies--;
                    copiesInput.value = state.printSettings.copies;
                }
            });

            copiesIncrement.addEventListener('click', () => {
                if (state.printSettings.copies < 99) {
                    state.printSettings.copies++;
                    copiesInput.value = state.printSettings.copies;
                }
            });

            // å•åŒé¢æ§åˆ¶
            sidesOne.addEventListener('click', () => {
                state.printSettings.sides = 'one-sided';
                updateSidesButtons();
            });

            sidesTwo.addEventListener('click', () => {
                state.printSettings.sides = 'two-sided';
                updateSidesButtons();
            });

            // è‰²å½©æ§åˆ¶
            colorBw.addEventListener('click', () => {
                state.printSettings.color_mode = 'monochrome';
                updateColorButtons();
            });

            colorColor.addEventListener('click', () => {
                state.printSettings.color_mode = 'color';
                updateColorButtons();
            });

            function updateSidesButtons() {
                if (state.printSettings.sides === 'one-sided') {
                    sidesOne.style.background = 'var(--accent)';
                    sidesOne.style.color = '#fbf1c7';
                    sidesTwo.style.background = 'var(--bg2)'
                    sidesTwo.style.color = 'var(--fg0)';
                } else {
                    sidesTwo.style.background = 'var(--accent)';
                    sidesTwo.style.color = '#fbf1c7';
                    sidesOne.style.background = 'var(--bg2)';
                    sidesOne.style.color = 'var(--fg0)';
                }
            }

            function updateColorButtons() {
                if (state.printSettings.color_mode === 'monochrome') {
                    colorBw.style.background = 'var(--accent)';
                    colorBw.style.color = '#fbf1c7';
                    colorColor.style.background = 'var(--bg2)';
                    colorColor.style.color = 'var(--fg0)';
                } else {
                    colorColor.style.background = 'var(--accent)';
                    colorColor.style.color = '#fbf1c7';
                    colorBw.style.background = 'var(--bg2)';
                    colorBw.style.color = 'var(--fg0)';
                }
            }
        }

        // ==================== æ‰“å°æœºçŠ¶æ€è½®è¯¢ ====================

        function startPrinterStatusPolling() {
            // å…ˆæ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (state.printerStatusInterval) {
                clearInterval(state.printerStatusInterval);
            }

            // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡
            updatePrinterStatus();

            // æ¯30ç§’è½®è¯¢
            state.printerStatusInterval = setInterval(updatePrinterStatus, 30000);
        }

        async function updatePrinterStatus() {
            try {
                const statusData = await apiRequest('/printer/status');
                state.printerStatus = statusData.status;

                const statusElement = document.getElementById('printer-status');
                const dot = statusElement.querySelector('.rounded-full');
                const text = statusElement.querySelector('span:last-child');

                if (statusData.status === 'online') {
                    dot.style.background = 'var(--success)';
                    text.textContent = (statusData.printer_name ? 'ğŸŸ¢ ' + statusData.printer_name : 'ğŸŸ¢ æ‰“å°æœºåœ¨çº¿');
                    text.style.color = 'var(--fg1)';
                } else {
                    dot.style.background = 'var(--error)';
                    text.textContent = (statusData.error ? 'ğŸ”´ ' + statusData.error : 'ğŸ”´ æ‰“å°æœºç¦»çº¿');
                    text.style.color = 'var(--fg1)';
                }
            } catch (error) {
                console.error('è·å–æ‰“å°æœºçŠ¶æ€å¤±è´¥:', error);
                const statusElement = document.getElementById('printer-status');
                const dot = statusElement.querySelector('.rounded-full');
                const text = statusElement.querySelector('span:last-child');
                dot.style.background = 'var(--warning)';
                text.textContent = 'ğŸŸ¡ çŠ¶æ€æŸ¥è¯¢å¤±è´¥';
                text.style.color = 'var(--fg1)';
            }
        }

        // ==================== æ‰“å°å’Œå–æ¶ˆåŠŸèƒ½ ====================

        function initPrintAndCancel() {
            const cancelBtn = document.getElementById('cancel-btn');
            const printBtn = document.getElementById('print-btn');
            const cancelBtnDesktop = document.getElementById('cancel-btn-desktop');
            const printBtnDesktop = document.getElementById('print-btn-desktop');

            // ç§»åŠ¨ç«¯æŒ‰é’®
            cancelBtn.addEventListener('click', handleCancel);
            printBtn.addEventListener('click', handlePrint);

            // æ¡Œé¢ç«¯æŒ‰é’®
            cancelBtnDesktop.addEventListener('click', handleCancel);
            printBtnDesktop.addEventListener('click', handlePrint);

            // é€€å‡ºæŒ‰é’®
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        async function handlePrint() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„æ–‡ä»¶
            if (state.uploadedFiles.length === 0) {
                showToast('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶
            const hasSuccessFile = state.uploadedFiles.some(f => f.status === 'success');
            if (!hasSuccessFile) {
                showToast('è¯·ç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½
            disablePrintButtons(true);
            showLoading('æ‰“å°ä¸­...');

            try {
                const printData = {
                    copies: state.printSettings.copies,
                    sides: state.printSettings.sides,
                    color_mode: state.printSettings.color_mode
                };

                await apiRequest('/print', {
                    method: 'POST',
                    body: printData
                });

                showToast('æ‰“å°ä»»åŠ¡å·²æäº¤', 'success');

                // é‡ç½®ç•Œé¢
                resetAfterPrint();

            } catch (error) {
                showToast(`æ‰“å°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
                disablePrintButtons(false);
            }
        }

        async function handleCancel() {
            if (state.uploadedFiles.length === 0) {
                showToast('æ²¡æœ‰æ–‡ä»¶éœ€è¦å–æ¶ˆ', 'info');
                return;
            }

            showLoading('å–æ¶ˆä¸­...');

            try {
                await apiRequest('/cancel', {
                    method: 'POST'
                });

                showToast('å·²å–æ¶ˆæ‰“å°ä»»åŠ¡', 'success');

                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å’Œé¢„è§ˆ
                state.uploadedFiles = [];
                updateFileList();
                updatePreview();

            } catch (error) {
                showToast(`å–æ¶ˆå¤±è´¥: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            // æ¸…é™¤è½®è¯¢
            if (state.printerStatusInterval) {
                clearInterval(state.printerStatusInterval);
                state.printerStatusInterval = null;
            }
            // åˆ·æ–°é¡µé¢
            window.location.reload();
        }

        function disablePrintButtons(disabled) {
            const buttons = [
                document.getElementById('print-btn'),
                document.getElementById('print-btn-desktop'),
                document.getElementById('cancel-btn'),
                document.getElementById('cancel-btn-desktop')
            ];

            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = disabled;
                    if (disabled) {
                        if (btn.id.includes('print')) {
                            btn.textContent = 'æ‰“å°ä¸­...';
                        }
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        if (btn.id.includes('print')) {
                            btn.textContent = 'æ‰“å°';
                        }
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
        }

        function resetAfterPrint() {
            state.uploadedFiles = [];
            updateFileList();
            updatePreview();
            // é‡ç½®æ‰“å°è®¾ç½®ä¸ºé»˜è®¤
            state.printSettings.copies = 1;
            state.printSettings.sides = 'one-sided';
            state.printSettings.color_mode = 'monochrome';

            // æ›´æ–°UI
            document.getElementById('copies-input').value = 1;
            initPrintSettings();
        }

        // ==================== é¡µé¢åˆå§‹åŒ– ====================

        function init() {
            console.log('Just-Printing-Server å‰ç«¯åˆå§‹åŒ–');

            // åˆå§‹åŒ–è®¤è¯
            initAuth();

            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
            initFileUpload();

            // åˆå§‹åŒ–æ‰“å°å’Œå–æ¶ˆ
            initPrintAndCancel();

            // åˆå§‹åŒ–æ‰“å°è®¾ç½®ï¼ˆåœ¨è®¤è¯æˆåŠŸåè°ƒç”¨ï¼‰
            // initPrintSettings() ä¼šåœ¨è®¤è¯æˆåŠŸåè°ƒç”¨

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', checkDeviceWidth);

            // åˆå§‹è®¾å¤‡æ£€æµ‹
            checkDeviceWidth();
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>